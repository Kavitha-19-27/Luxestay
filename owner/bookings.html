<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Manage Your Hotel Bookings - LuxeStay">
    <title>Bookings | LuxeStay</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3EðŸ’Ž%3C/text%3E%3C/svg%3E">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <link rel="stylesheet" href="../assets/css/base.css">
    <link rel="stylesheet" href="../assets/css/components.css">
    <link rel="stylesheet" href="../assets/css/layout.css">
    <link rel="stylesheet" href="../assets/css/pages/admin.css">
    <link rel="stylesheet" href="../assets/css/pages/owner.css">
    <link rel="stylesheet" href="../assets/css/premium-enhancements.css">
</head>
<body class="admin-body owner-body">
    <!-- Sidebar -->
    <aside class="admin-sidebar owner-sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="../index.html" class="sidebar-logo">
                <span class="brand-icon"><i class="fas fa-gem"></i></span>
                <span class="brand-text">LuxeStay</span>
            </a>
            <span class="owner-badge">Hotel Owner</span>
        </div>
        
        <nav class="sidebar-nav">
            <a href="dashboard.html" class="sidebar-link">
                <i class="fas fa-tachometer-alt"></i>
                <span>Dashboard</span>
            </a>
            <a href="rooms.html" class="sidebar-link">
                <i class="fas fa-bed"></i>
                <span>My Rooms</span>
            </a>
            <a href="bookings.html" class="sidebar-link active">
                <i class="fas fa-calendar-check"></i>
                <span>Bookings</span>
            </a>
            <a href="reviews.html" class="sidebar-link">
                <i class="fas fa-star"></i>
                <span>Reviews</span>
            </a>
            <a href="hotel-settings.html" class="sidebar-link">
                <i class="fas fa-cog"></i>
                <span>Hotel Settings</span>
            </a>
        </nav>
        
        <div class="sidebar-footer">
            <a href="../index.html" class="sidebar-link">
                <i class="fas fa-arrow-left"></i>
                <span>Back to Site</span>
            </a>
            <button class="sidebar-link" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="admin-main">
        <!-- Top Bar -->
        <header class="admin-topbar">
            <button class="sidebar-toggle" id="sidebarToggle">
                <i class="fas fa-bars"></i>
            </button>
            
            <div class="topbar-hotel-info">
                <span class="hotel-name" id="hotelName">Loading...</span>
            </div>
            
            <div class="topbar-actions">
                <button class="topbar-btn" id="refreshBtn" title="Refresh Data">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <div class="topbar-user">
                    <span class="user-avatar" id="userAvatar">O</span>
                    <span class="user-name" id="userName">Owner</span>
                </div>
            </div>
        </header>

        <!-- Bookings Content -->
        <main class="admin-content">
            <div class="content-header">
                <div>
                    <h1>Bookings</h1>
                    <p class="content-subtitle">Manage guest reservations and check-ins</p>
                </div>
            </div>

            <!-- Status Tabs -->
            <div class="status-tabs">
                <button class="status-tab active" data-status="" onclick="filterByStatus('')">
                    <i class="fas fa-list"></i> All <span class="count" id="countAll">0</span>
                </button>
                <button class="status-tab" data-status="PENDING" onclick="filterByStatus('PENDING')">
                    <i class="fas fa-clock"></i> Pending <span class="count" id="countPending">0</span>
                </button>
                <button class="status-tab" data-status="CONFIRMED" onclick="filterByStatus('CONFIRMED')">
                    <i class="fas fa-check-circle"></i> Confirmed <span class="count" id="countConfirmed">0</span>
                </button>
                <button class="status-tab" data-status="CHECKED_IN" onclick="filterByStatus('CHECKED_IN')">
                    <i class="fas fa-door-open"></i> Checked In <span class="count" id="countCheckedIn">0</span>
                </button>
                <button class="status-tab" data-status="CHECKED_OUT" onclick="filterByStatus('CHECKED_OUT')">
                    <i class="fas fa-door-closed"></i> Checked Out <span class="count" id="countCheckedOut">0</span>
                </button>
                <button class="status-tab" data-status="CANCELLED" onclick="filterByStatus('CANCELLED')">
                    <i class="fas fa-ban"></i> Cancelled <span class="count" id="countCancelled">0</span>
                </button>
            </div>

            <!-- Filters -->
            <div class="booking-filters">
                <div class="date-range-filters">
                    <div class="date-filter-group">
                        <label>From Date</label>
                        <input type="date" id="dateFrom" class="form-input" onchange="applyFilters()">
                    </div>
                    <div class="date-filter-group">
                        <label>To Date</label>
                        <input type="date" id="dateTo" class="form-input" onchange="applyFilters()">
                    </div>
                </div>
                <div class="booking-search">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" class="form-input" placeholder="Search by reference or guest..." oninput="applyFilters()">
                </div>
            </div>

            <!-- Bookings Table -->
            <div class="dashboard-card dashboard-card-full">
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Reference</th>
                                <th>Guest</th>
                                <th>Room</th>
                                <th>Check-in</th>
                                <th>Check-out</th>
                                <th>Guests</th>
                                <th>Status</th>
                                <th>Amount</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="bookingsTable">
                            <tr>
                                <td colspan="9" class="text-center">Loading bookings...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Pagination -->
            <div class="pagination" id="pagination"></div>
        </main>
    </div>

    <!-- View Booking Modal -->
    <div class="modal" id="viewBookingModal">
        <div class="modal-overlay"></div>
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h3>Booking Details</h3>
                <button class="modal-close" onclick="closeModal('viewBookingModal')">&times;</button>
            </div>
            <div class="modal-body" id="bookingDetails">
                Loading...
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-ghost" onclick="closeModal('viewBookingModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Update Status Modal -->
    <div class="modal" id="updateStatusModal">
        <div class="modal-overlay"></div>
        <div class="modal-content modal-sm">
            <div class="modal-header">
                <h3>Update Booking Status</h3>
                <button class="modal-close" onclick="closeModal('updateStatusModal')">&times;</button>
            </div>
            <form id="updateStatusForm" onsubmit="handleUpdateStatus(event)">
                <div class="modal-body">
                    <input type="hidden" id="statusBookingId" name="bookingId">
                    <div class="form-group">
                        <label for="newStatus">New Status</label>
                        <select id="newStatus" name="status" required class="form-select" onchange="handleStatusChange()">
                            <option value="PENDING">Pending</option>
                            <option value="CONFIRMED">Confirmed</option>
                            <option value="CHECKED_IN">Checked In</option>
                            <option value="CHECKED_OUT">Checked Out</option>
                            <option value="CANCELLED">Cancelled</option>
                        </select>
                    </div>
                    <div class="form-group" id="reasonGroup" style="display: none;">
                        <label for="statusReason">Cancellation Reason</label>
                        <textarea id="statusReason" name="reason" class="form-textarea" rows="3" placeholder="Reason for cancellation..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-ghost" onclick="closeModal('updateStatusModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Status</button>
                </div>
            </form>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <script src="../assets/js/config.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/ui.js"></script>
    <script>
        let allBookings = [];
        let currentPage = 0;
        let totalPages = 0;
        let currentStatus = '';
        const pageSize = 15;

        document.addEventListener('DOMContentLoaded', () => {
            // Check hotel owner access
            if (!requireHotelOwner()) return;
            
            // Set user info
            const user = Auth.getUser();
            document.getElementById('userAvatar').textContent = Auth.getUserInitials();
            document.getElementById('userName').textContent = user?.firstName || 'Owner';
            document.getElementById('hotelName').textContent = user?.hotelName || 'My Hotel';
            
            // Sidebar toggle
            document.getElementById('sidebarToggle').addEventListener('click', () => {
                document.getElementById('sidebar').classList.toggle('collapsed');
            });
            
            // Logout handler
            document.getElementById('logoutBtn').addEventListener('click', () => {
                Auth.logout();
                window.location.href = '../index.html';
            });
            
            // Refresh button
            document.getElementById('refreshBtn').addEventListener('click', () => loadBookings());
            
            // Load bookings
            loadBookings();
        });

        async function loadBookings(page = 0) {
            try {
                currentPage = page;
                
                const params = {
                    page: page,
                    size: pageSize
                };
                
                if (currentStatus) {
                    params.status = currentStatus;
                }
                
                const response = await API.owner.getBookings(params);
                const data = response.data || response;
                
                allBookings = data.content || data || [];
                totalPages = data.totalPages || 1;
                
                // Count by status for tabs
                updateStatusCounts(allBookings);
                
                applyFilters();
                renderPagination();
            } catch (error) {
                console.error('Failed to load bookings:', error);
                UI.toast('Failed to load bookings', 'error');
            }
        }

        function updateStatusCounts(bookings) {
            // These would ideally come from the API
            document.getElementById('countAll').textContent = bookings.length;
            document.getElementById('countPending').textContent = bookings.filter(b => b.status === 'PENDING').length;
            document.getElementById('countConfirmed').textContent = bookings.filter(b => b.status === 'CONFIRMED').length;
            document.getElementById('countCheckedIn').textContent = bookings.filter(b => b.status === 'CHECKED_IN').length;
            document.getElementById('countCheckedOut').textContent = bookings.filter(b => b.status === 'CHECKED_OUT').length;
            document.getElementById('countCancelled').textContent = bookings.filter(b => b.status === 'CANCELLED').length;
        }

        function filterByStatus(status) {
            currentStatus = status;
            
            // Update active tab
            document.querySelectorAll('.status-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.status === status);
            });
            
            loadBookings(0);
        }

        function applyFilters() {
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            let filtered = allBookings;
            
            if (dateFrom) {
                filtered = filtered.filter(b => b.checkInDate >= dateFrom);
            }
            
            if (dateTo) {
                filtered = filtered.filter(b => b.checkOutDate <= dateTo);
            }
            
            if (searchTerm) {
                filtered = filtered.filter(b => 
                    b.bookingReference?.toLowerCase().includes(searchTerm) ||
                    b.userFullName?.toLowerCase().includes(searchTerm) ||
                    b.guestName?.toLowerCase().includes(searchTerm)
                );
            }
            
            renderBookings(filtered);
        }

        function renderBookings(bookings) {
            const tableBody = document.getElementById('bookingsTable');
            
            if (!bookings || bookings.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="9" class="text-center">No bookings found</td></tr>';
                return;
            }
            
            const statusBadges = {
                'PENDING': 'badge-warning',
                'CONFIRMED': 'badge-success',
                'CHECKED_IN': 'badge-info',
                'CHECKED_OUT': 'badge-secondary',
                'CANCELLED': 'badge-error',
                'COMPLETED': 'badge-info'
            };
            
            tableBody.innerHTML = bookings.map(booking => {
                const badgeClass = statusBadges[booking.status] || 'badge-info';
                const statusLabel = formatStatus(booking.status);
                
                return `
                    <tr>
                        <td><code>${booking.bookingReference || 'N/A'}</code></td>
                        <td>
                            <div class="guest-info">
                                <span class="guest-name">${booking.userFullName || booking.guestName || 'N/A'}</span>
                                ${booking.userEmail ? `<small class="guest-email">${booking.userEmail}</small>` : ''}
                            </div>
                        </td>
                        <td>
                            <span class="room-badge">${booking.roomNumber || ''}</span>
                            <small>${booking.roomType || ''}</small>
                        </td>
                        <td>${formatDate(booking.checkInDate)}</td>
                        <td>${formatDate(booking.checkOutDate)}</td>
                        <td><i class="fas fa-users"></i> ${booking.numberOfGuests || 1}</td>
                        <td><span class="badge ${badgeClass}">${statusLabel}</span></td>
                        <td><strong>â‚¹${parseFloat(booking.totalPrice || 0).toLocaleString('en-IN')}</strong></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-ghost" onclick="viewBooking(${booking.id})" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-ghost" onclick="showUpdateStatusModal(${booking.id}, '${booking.status}')" title="Update Status">
                                    <i class="fas fa-edit"></i>
                                </button>
                                ${booking.status === 'CONFIRMED' ? `
                                    <button class="btn btn-sm btn-success" onclick="quickCheckIn(${booking.id})" title="Quick Check-in">
                                        <i class="fas fa-sign-in-alt"></i>
                                    </button>
                                ` : ''}
                                ${booking.status === 'CHECKED_IN' ? `
                                    <button class="btn btn-sm btn-warning" onclick="quickCheckOut(${booking.id})" title="Quick Check-out">
                                        <i class="fas fa-sign-out-alt"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function formatStatus(status) {
            return status ? status.replace(/_/g, ' ').toLowerCase()
                .split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ') : '';
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
        }

        function renderPagination() {
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            let html = '';
            
            html += `<button class="pagination-btn" ${currentPage === 0 ? 'disabled' : ''} onclick="loadBookings(${currentPage - 1})">
                <i class="fas fa-chevron-left"></i>
            </button>`;
            
            for (let i = 0; i < totalPages; i++) {
                html += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="loadBookings(${i})">${i + 1}</button>`;
            }
            
            html += `<button class="pagination-btn" ${currentPage === totalPages - 1 ? 'disabled' : ''} onclick="loadBookings(${currentPage + 1})">
                <i class="fas fa-chevron-right"></i>
            </button>`;
            
            pagination.innerHTML = html;
        }

        async function viewBooking(id) {
            const booking = allBookings.find(b => b.id === id);
            if (!booking) return;
            
            document.getElementById('bookingDetails').innerHTML = `
                <div class="booking-details-grid">
                    <div class="detail-section">
                        <h4>Booking Information</h4>
                        <div class="detail-row">
                            <span class="detail-label">Reference:</span>
                            <span class="detail-value"><code>${booking.bookingReference}</code></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Status:</span>
                            <span class="detail-value"><span class="badge badge-${getStatusBadge(booking.status)}">${formatStatus(booking.status)}</span></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Created:</span>
                            <span class="detail-value">${booking.createdAt ? new Date(booking.createdAt).toLocaleString('en-IN') : 'N/A'}</span>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h4>Guest Information</h4>
                        <div class="detail-row">
                            <span class="detail-label">Name:</span>
                            <span class="detail-value">${booking.userFullName || booking.guestName || 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Email:</span>
                            <span class="detail-value">${booking.userEmail || 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Phone:</span>
                            <span class="detail-value">${booking.userPhone || 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Guests:</span>
                            <span class="detail-value">${booking.numberOfGuests || 1}</span>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h4>Stay Details</h4>
                        <div class="detail-row">
                            <span class="detail-label">Room:</span>
                            <span class="detail-value">${booking.roomNumber || ''} - ${booking.roomType || ''}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Check-in:</span>
                            <span class="detail-value">${formatDate(booking.checkInDate)}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Check-out:</span>
                            <span class="detail-value">${formatDate(booking.checkOutDate)}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Nights:</span>
                            <span class="detail-value">${booking.nights || calculateNights(booking.checkInDate, booking.checkOutDate)}</span>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h4>Payment Details</h4>
                        <div class="detail-row">
                            <span class="detail-label">Total Amount:</span>
                            <span class="detail-value"><strong>â‚¹${parseFloat(booking.totalPrice || 0).toLocaleString('en-IN')}</strong></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Payment Status:</span>
                            <span class="detail-value">${booking.paymentStatus || 'PENDING'}</span>
                        </div>
                    </div>
                    
                    ${booking.specialRequests ? `
                        <div class="detail-section full-width">
                            <h4>Special Requests</h4>
                            <p>${booking.specialRequests}</p>
                        </div>
                    ` : ''}
                </div>
            `;
            
            document.getElementById('viewBookingModal').classList.add('active');
        }

        function calculateNights(checkIn, checkOut) {
            if (!checkIn || !checkOut) return 1;
            const diff = new Date(checkOut) - new Date(checkIn);
            return Math.ceil(diff / (1000 * 60 * 60 * 24)) || 1;
        }

        function getStatusBadge(status) {
            const badges = {
                'PENDING': 'warning',
                'CONFIRMED': 'success',
                'CHECKED_IN': 'info',
                'CHECKED_OUT': 'secondary',
                'CANCELLED': 'error'
            };
            return badges[status] || 'info';
        }

        function showUpdateStatusModal(id, currentStatus) {
            document.getElementById('statusBookingId').value = id;
            document.getElementById('newStatus').value = currentStatus;
            document.getElementById('statusReason').value = '';
            document.getElementById('reasonGroup').style.display = 'none';
            document.getElementById('updateStatusModal').classList.add('active');
        }

        function handleStatusChange() {
            const status = document.getElementById('newStatus').value;
            document.getElementById('reasonGroup').style.display = status === 'CANCELLED' ? 'block' : 'none';
        }

        async function handleUpdateStatus(event) {
            event.preventDefault();
            
            const bookingId = document.getElementById('statusBookingId').value;
            const status = document.getElementById('newStatus').value;
            const reason = document.getElementById('statusReason').value;
            
            try {
                await API.owner.updateBookingStatus(bookingId, status, reason || null);
                UI.toast('Booking status updated', 'success');
                closeModal('updateStatusModal');
                loadBookings(currentPage);
            } catch (error) {
                console.error('Failed to update status:', error);
                UI.toast(error.message || 'Failed to update status', 'error');
            }
        }

        async function quickCheckIn(id) {
            try {
                await API.owner.updateBookingStatus(id, 'CHECKED_IN');
                UI.toast('Guest checked in successfully', 'success');
                loadBookings(currentPage);
            } catch (error) {
                console.error('Failed to check in:', error);
                UI.toast('Failed to check in guest', 'error');
            }
        }

        async function quickCheckOut(id) {
            try {
                await API.owner.updateBookingStatus(id, 'CHECKED_OUT');
                UI.toast('Guest checked out successfully', 'success');
                loadBookings(currentPage);
            } catch (error) {
                console.error('Failed to check out:', error);
                UI.toast('Failed to check out guest', 'error');
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Close modals on overlay click
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                e.target.closest('.modal').classList.remove('active');
            }
        });

        // Close modals with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal.active').forEach(modal => {
                    modal.classList.remove('active');
                });
            }
        });
    </script>
</body>
</html>
