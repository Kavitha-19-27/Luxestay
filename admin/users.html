<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Manage Users - LuxeStay Admin">
    <title>Manage Users | LuxeStay Admin</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3EðŸ’Ž%3C/text%3E%3C/svg%3E">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <link rel="stylesheet" href="../assets/css/base.css">
    <link rel="stylesheet" href="../assets/css/components.css">
    <link rel="stylesheet" href="../assets/css/layout.css">
    <link rel="stylesheet" href="../assets/css/pages/admin.css">
    <link rel="stylesheet" href="../assets/css/premium-enhancements.css">
</head>
<body class="admin-body">
    <!-- Sidebar -->
    <aside class="admin-sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="../index.html" class="sidebar-logo">
                <span class="brand-icon"><i class="fas fa-gem"></i></span>
                <span class="brand-text">LuxeStay</span>
            </a>
            <span class="admin-badge">Admin</span>
        </div>
        
        <nav class="sidebar-nav">
            <a href="dashboard.html" class="sidebar-link">
                <i class="fas fa-tachometer-alt"></i>
                <span>Dashboard</span>
            </a>
            <a href="hotels.html" class="sidebar-link">
                <i class="fas fa-hotel"></i>
                <span>Hotels</span>
            </a>
            <a href="rooms.html" class="sidebar-link">
                <i class="fas fa-bed"></i>
                <span>Rooms</span>
            </a>
            <a href="bookings.html" class="sidebar-link">
                <i class="fas fa-calendar-check"></i>
                <span>Bookings</span>
            </a>
            <a href="reviews.html" class="sidebar-link">
                <i class="fas fa-star"></i>
                <span>Reviews</span>
            </a>
            <a href="destinations.html" class="sidebar-link">
                <i class="fas fa-map-marker-alt"></i>
                <span>Destinations</span>
            </a>
            <a href="users.html" class="sidebar-link active">
                <i class="fas fa-users"></i>
                <span>Users</span>
            </a>
        </nav>
        
        <div class="sidebar-footer">
            <a href="../index.html" class="sidebar-link">
                <i class="fas fa-arrow-left"></i>
                <span>Back to Site</span>
            </a>
            <button class="sidebar-link" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="admin-main">
        <header class="admin-topbar">
            <button class="sidebar-toggle" id="sidebarToggle">
                <i class="fas fa-bars"></i>
            </button>
            
            <div class="topbar-search">
                <i class="fas fa-search"></i>
                <input type="text" placeholder="Search users..." id="searchInput">
            </div>
            
            <div class="topbar-actions">
                <button class="topbar-btn">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge">3</span>
                </button>
                <div class="topbar-user">
                    <span class="user-avatar" id="userAvatar">A</span>
                    <span class="user-name" id="userName">Admin</span>
                </div>
            </div>
        </header>

        <main class="admin-content">
            <div class="content-header">
                <div>
                    <h1>Users</h1>
                    <p class="content-subtitle">Manage registered users and their accounts</p>
                </div>
            </div>

            <!-- Users Table -->
            <div class="dashboard-card">
                <div class="card-header">
                    <h3>All Users (<span id="userCount">0</span>)</h3>
                    <div class="table-filters">
                        <form autocomplete="off" onsubmit="return false;">
                            <select class="form-select-sm" id="userRoleFilter" name="x_role_filter_x" autocomplete="off">
                                <option value="">All Roles</option>
                                <option value="USER">Users</option>
                                <option value="ADMIN">Admins</option>
                            </select>
                        </form>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                    <th>Joined</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody"></tbody>
                        </table>
                    </div>
                    
                    <div class="loading-state" id="loadingState">
                        <div class="spinner"></div>
                        <p>Loading users...</p>
                    </div>
                    
                    <div class="empty-state hidden" id="emptyState">
                        <i class="fas fa-users"></i>
                        <h3>No Users Found</h3>
                        <p>No users match your current filters.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- User Details Modal -->
    <div class="modal" id="userModal">
        <div class="modal-overlay"></div>
        <div class="modal-container">
            <div class="modal-header">
                <h3>User Details</h3>
                <button class="modal-close" id="closeModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="userDetails">
                <!-- Loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" id="closeUserBtn">Close</button>
            </div>
        </div>
    </div>

    <!-- Role Assignment Modal -->
    <div class="modal" id="roleModal">
        <div class="modal-overlay"></div>
        <div class="modal-container">
            <div class="modal-header">
                <h3>Assign Role</h3>
                <button class="modal-close" id="closeRoleModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="roleForm">
                <div class="modal-body">
                    <input type="hidden" id="roleUserId">
                    <p id="roleUserName" class="mb-3" style="font-weight: 500;"></p>
                    
                    <div class="form-group">
                        <label for="newRole" class="form-label">New Role *</label>
                        <select id="newRole" class="form-select" required>
                            <option value="USER">User</option>
                            <option value="ADMIN">Admin</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" id="cancelRoleBtn">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="saveRoleBtn">Save Role</button>
                </div>
            </form>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <script src="../assets/js/config.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/ui.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (!Auth.isAuthenticated()) {
                window.location.href = '../login.html';
                return;
            }
            
            if (!Auth.isAdmin()) {
                UI.toast('Access denied. Admin privileges required.', 'error');
                setTimeout(() => window.location.href = '../index.html', 2000);
                return;
            }
            
            initAdminUsers();
        });

        // Reset filters when navigating back to page (bfcache)
        window.addEventListener('pageshow', function(event) {
            document.getElementById('userRoleFilter').value = '';
            document.getElementById('searchInput').value = '';
        });

        // No fallback data - database is the only source of truth

        let users = [];
        let hotels = [];

        function initAdminUsers() {
            const user = Auth.getUser();
            document.getElementById('userAvatar').textContent = Auth.getUserInitials();
            document.getElementById('userName').textContent = user?.firstName || 'Admin';
            
            document.getElementById('sidebarToggle').addEventListener('click', () => {
                document.getElementById('sidebar').classList.toggle('collapsed');
            });
            
            document.getElementById('logoutBtn').addEventListener('click', () => {
                Auth.logout();
                window.location.href = '../index.html';
            });
            
            // Reset filters immediately
            document.getElementById('userRoleFilter').value = '';
            document.getElementById('searchInput').value = '';
            
            // Also reset after a delay (browser may restore forms after DOMContentLoaded)
            setTimeout(() => {
                document.getElementById('userRoleFilter').value = '';
                document.getElementById('searchInput').value = '';
            }, 100);
            
            loadHotels();
            loadUsers();
            setupEventListeners();
        }

        async function loadHotels() {
            try {
                const response = await API.admin.getHotels();
                hotels = response.data || response.content || response || [];
            } catch (error) {
                hotels = [];
            }
            
            // Populate hotel assignment dropdown
            const hotelSelect = document.getElementById('assignHotelId');
            hotelSelect.innerHTML = '<option value="">Select a hotel...</option>';
            hotels.forEach(hotel => {
                hotelSelect.innerHTML += `<option value="${hotel.id}">${hotel.name}</option>`;
            });
        }

        async function loadUsers() {
            const loadingState = document.getElementById('loadingState');
            const tableBody = document.getElementById('usersTableBody');
            
            loadingState.classList.remove('hidden');
            tableBody.innerHTML = '';
            
            try {
                const response = await API.admin.getUsers();
                users = response.data?.content || response.content || response.data || response || [];
            } catch (error) {
                console.error('Failed to load users:', error);
                users = [];
                UI.toast('Failed to load users. Please try again.', 'error');
            }
            
            loadingState.classList.add('hidden');
            document.getElementById('userCount').textContent = users.length;
            
            // Force reset filter AFTER data loads (browser may have restored it)
            document.getElementById('userRoleFilter').selectedIndex = 0;
            document.getElementById('searchInput').value = '';
            
            renderUsers(users);
        }

        function getRoleBadgeClass(role) {
            switch (role) {
                case 'ADMIN': return 'badge-gold';
                default: return 'badge-info';
            }
        }

        function renderUsers(userList) {
            const tableBody = document.getElementById('usersTableBody');
            
            if (userList.length === 0) {
                document.getElementById('emptyState').classList.remove('hidden');
                tableBody.innerHTML = '';
                return;
            }
            
            document.getElementById('emptyState').classList.add('hidden');
            
            tableBody.innerHTML = userList.map(user => `
                <tr>
                    <td>
                        <div class="user-info">
                            <span class="user-avatar-sm">${user.firstName.charAt(0)}${user.lastName.charAt(0)}</span>
                            <span class="user-fullname">${user.firstName} ${user.lastName}</span>
                        </div>
                    </td>
                    <td>${user.email}</td>
                    <td>
                        <span class="badge ${getRoleBadgeClass(user.role)}">
                            ${user.role}
                        </span>
                    </td>
                    <td>
                        <span class="badge ${user.isActive ? 'badge-success' : 'badge-error'}">
                            ${user.isActive ? 'Active' : 'Disabled'}
                        </span>
                    </td>
                    <td>${UI.formatDate(user.createdAt)}</td>
                    <td>
                        <div class="table-actions">
                            <button class="action-btn view-btn" title="View Details" onclick="viewUser(${user.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn edit-btn" title="Change Role" onclick="openRoleModal(${user.id})">
                                <i class="fas fa-user-tag"></i>
                            </button>
                            <button class="action-btn ${user.isActive ? 'delete-btn' : ''}" 
                                    title="${user.isActive ? 'Disable' : 'Enable'} User" 
                                    onclick="toggleUserStatus(${user.id})">
                                <i class="fas fa-${user.isActive ? 'ban' : 'check'}"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function setupEventListeners() {
            const modal = document.getElementById('userModal');
            const roleModal = document.getElementById('roleModal');
            
            document.getElementById('closeModal').addEventListener('click', () => modal.classList.remove('active'));
            document.getElementById('closeUserBtn').addEventListener('click', () => modal.classList.remove('active'));
            modal.querySelector('.modal-overlay').addEventListener('click', () => modal.classList.remove('active'));
            
            // Role modal
            document.getElementById('closeRoleModal').addEventListener('click', () => roleModal.classList.remove('active'));
            document.getElementById('cancelRoleBtn').addEventListener('click', () => roleModal.classList.remove('active'));
            roleModal.querySelector('.modal-overlay').addEventListener('click', () => roleModal.classList.remove('active'));
            
            // Role form submission
            document.getElementById('roleForm').addEventListener('submit', handleRoleSubmit);
            
            document.getElementById('searchInput').addEventListener('input', filterUsers);
            document.getElementById('userRoleFilter').addEventListener('change', filterUsers);
        }

        function filterUsers() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const role = document.getElementById('userRoleFilter').value;
            
            let filtered = users.filter(user => {
                const matchSearch = 
                    user.firstName.toLowerCase().includes(search) ||
                    user.lastName.toLowerCase().includes(search) ||
                    user.email.toLowerCase().includes(search);
                const matchRole = !role || user.role === role;
                return matchSearch && matchRole;
            });
            
            renderUsers(filtered);
        }

        window.openRoleModal = function(id) {
            const user = users.find(u => u.id === id);
            if (!user) return;
            
            document.getElementById('roleUserId').value = user.id;
            document.getElementById('roleUserName').textContent = `Changing role for: ${user.firstName} ${user.lastName}`;
            document.getElementById('newRole').value = user.role;
            
            document.getElementById('roleModal').classList.add('active');
        };

        async function handleRoleSubmit(e) {
            e.preventDefault();
            
            const userId = document.getElementById('roleUserId').value;
            const newRole = document.getElementById('newRole').value;
            
            const saveBtn = document.getElementById('saveRoleBtn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            
            try {
                await API.admin.updateUserRole(userId, { role: newRole });
                UI.toast('User role updated successfully', 'success');
                document.getElementById('roleModal').classList.remove('active');
                await loadUsers();
            } catch (error) {
                console.error('Error updating role:', error);
                UI.toast('Failed to update user role. Please try again.', 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = 'Save Role';
            }
        }

        window.toggleUserStatus = async function(id) {
            const user = users.find(u => u.id === id);
            if (!user) return;
            
            const action = user.isActive ? 'disable' : 'enable';
            if (!confirm(`Are you sure you want to ${action} ${user.firstName} ${user.lastName}?`)) {
                return;
            }
            
            try {
                await API.admin.toggleUserStatus(id);
                UI.toast(`User ${action}d successfully`, 'success');
                await loadUsers();
            } catch (error) {
                console.error('Error toggling user status:', error);
                UI.toast(`Failed to ${action} user. Please try again.`, 'error');
            }
        };

        window.viewUser = function(id) {
            const user = users.find(u => u.id === id);
            if (!user) return;
            
            document.getElementById('userDetails').innerHTML = `
                <div class="user-profile-card">
                    <div class="profile-header">
                        <span class="profile-avatar">${user.firstName.charAt(0)}${user.lastName.charAt(0)}</span>
                        <div>
                            <h4>${user.firstName} ${user.lastName}</h4>
                        <span class="badge ${getRoleBadgeClass(user.role)}">${user.role}</span>
                        </div>
                    </div>
                    <div class="profile-details">
                        <div class="detail-row">
                            <span><i class="fas fa-envelope"></i> Email:</span>
                            <span>${user.email}</span>
                        </div>
                        <div class="detail-row">
                            <span><i class="fas fa-phone"></i> Phone:</span>
                            <span>${user.phone || 'Not provided'}</span>
                        </div>
                        <div class="detail-row">
                            <span><i class="fas fa-calendar-alt"></i> Bookings:</span>
                            <span>${user.bookingsCount || 0} total</span>
                        </div>
                        <div class="detail-row">
                            <span><i class="fas fa-toggle-on"></i> Status:</span>
                            <span class="badge ${user.isActive ? 'badge-success' : 'badge-error'}">${user.isActive ? 'Active' : 'Disabled'}</span>
                        </div>
                        <div class="detail-row">
                            <span><i class="fas fa-clock"></i> Member Since:</span>
                            <span>${UI.formatDate(user.createdAt)}</span>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('userModal').classList.add('active');
        };

        window.viewUserBookings = function(id) {
            window.location.href = `bookings.html?userId=${id}`;
        };
    </script>
</body>
</html>
